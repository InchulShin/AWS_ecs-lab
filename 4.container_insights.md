## ECS í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ CLOUDWATCH CONTAINER INSIGHTS êµ¬ì„±

### ì†Œê°œ
ì´ ì¥ì—ì„œëŠ” [Amazon CloudWatch Container Insights](https://docs.aws.amazon.com/AmazonECS/latest/developerguide/cloudwatch-container-insights.html)ë¥¼ í†µí•´ ECS í™˜ê²½ì— ëŒ€í•œ ëª¨ë‹ˆí„°ë§ì„ ì„¤ì •í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.

ë‹¹ì‹ ì´ ì‚¬ìš©í•  ìˆ˜ìˆëŠ” ìˆ˜ì§‘í•  CloudWatch Container Insights, ì»¨í…Œì´ë„ˆí™”ëœ ì• í”Œë¦¬ì¼€ì´ì…˜ ë° ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ì˜ ë©”íŠ¸ë¦­ ë° ë¡œê·¸ë¥¼ ì§‘ê³„ ë° ìš”ì•½í•©ë‹ˆë‹¤. Container InsightsëŠ” Amazon Elastic Container Service, Amazon Elastic Kubernetes Service ë° Amazon EC2ì˜ Kubernetes í”Œë«í¼ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë©”íŠ¸ë¦­ì—ëŠ” CPU, ë©”ëª¨ë¦¬, ë””ìŠ¤í¬ ë° ë„¤íŠ¸ì›Œí¬ì™€ ê°™ì€ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ì‚¬ìš©ë¥ ì´ í¬í•¨ë©ë‹ˆë‹¤. Container InsightsëŠ” ë˜í•œ ë¬¸ì œë¥¼ ê²©ë¦¬í•˜ê³  ì‹ ì†í•˜ê²Œ í•´ê²°í•  ìˆ˜ ìˆë„ë¡ ì»¨í…Œì´ë„ˆ ë‹¤ì‹œ ì‹œì‘ ì‹¤íŒ¨ì™€ ê°™ì€ ì§„ë‹¨ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

Amazon CloudWatch ë° AWS X-Rayë¥¼ ì‚¬ìš©í•˜ëŠ” ê´€ì°° ê°€ëŠ¥ì„± ê¸°ëŠ¥ì— ëŒ€í•´ ëª¨ë‘ ì•Œì•„ë³´ë ¤ë©´ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤. [observability-workshop](https://observability.workshop.aws/en/)

### ë„êµ¬ ì„¤ì¹˜ ë° êµ¬ì„±

Cloud9 ì‘ì—… ì˜ì—­ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

ì„¤ì¹˜ ë° ì„¤ì • ì „ì œ ì¡°ê±´
```
# Install prerequisite packages
sudo yum -y install jq gettext
```

jqëŠ” JSON íŒŒì¼ì— ì €ì¥ëœ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ê³  ë³€í™˜í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

gettext íŒ¨í‚¤ì§€ì—ëŠ” í™˜ê²½ ë³€ìˆ˜ ê°’ì„ ì…ë ¥ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” envsubst ìœ í‹¸ë¦¬í‹°ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

Linux ìœ í‹¸ë¦¬í‹° sedì™€ í•¨ê»˜ ì´ëŸ¬í•œ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›Œí¬ìƒµ ì „ë°˜ì— ê±¸ì³ ë‹¤ì–‘í•œ íŒŒì¼ì— ì†ì„± ê°’ì„ ì‚½ì…í•˜ê±°ë‚˜ êµì²´í•  ê²ƒì…ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ê°€ëŠ¥í•œ í•œ ìˆ˜ë™ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¥¼ í¸ì§‘í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

```
# Setting environment variables required to communicate with AWS API's via the cli tools
echo "export AWS_DEFAULT_REGION=$(curl -s 169.254.169.254/latest/dynamic/instance-identity/document | jq -r .region)" >> ~/.bashrc
echo "export AWS_REGION=\$AWS_DEFAULT_REGION" >> ~/.bashrc
echo "export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)" >> ~/.bashrc
source ~/.bashrc
```

### í™˜ê²½ êµ¬ì¶•

Cloud9 ì‘ì—… ì˜ì—­ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

ë¡œë“œ ë°¸ëŸ°ì„œ ë° ECSì— ëŒ€í•œ ì„œë¹„ìŠ¤ ì—°ê²° ì—­í• ì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```
aws iam get-role --role-name "AWSServiceRoleForElasticLoadBalancing" || aws iam create-service-linked-role --aws-service-name "elasticloadbalancing.amazonaws.com"

aws iam get-role --role-name "AWSServiceRoleForECS" || aws iam create-service-linked-role --aws-service-name "ecs.amazonaws.com"
```

ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
ì´ ì„¹ì…˜ì—ì„œëŠ” ì»¨í…Œì´ë„ˆ ì¸ì‚¬ì´íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤. ì‹œì‘í•˜ë ¤ë©´ ECSì— í™˜ê²½ê³¼ í”„ëŸ°íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ë¥¼ ë°°í¬í•´ì•¼ í•©ë‹ˆë‹¤. ì´ì „ ì¥ì—ì„œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¥¼ ë°°í¬í–ˆë‹¤ë©´ ì´ ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³  ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì €ì¥ì†Œ ë³µì œ
ì„œë¹„ìŠ¤ ì €ì¥ì†Œë¥¼ ë³µì œí•©ë‹ˆë‹¤.

```
cd ~/environment
git clone https://github.com/brentley/container-demo
git clone https://github.com/brentley/ecsdemo-frontend
git clone https://github.com/brentley/ecsdemo-nodejs
git clone https://github.com/brentley/ecsdemo-crystal
```

í”Œë«í¼ êµ¬ì¶•
ë¨¼ì € í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë  í™˜ê²½ì„ êµ¬ì¶•í•´ì•¼ í•©ë‹ˆë‹¤. ìš°ë¦¬ê°€ ë§Œë“¤ê³  ìˆëŠ” ê²ƒì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì—¬ê¸°ì—ì„œ ì½”ë“œë¥¼ ê²€í† í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.í”Œë«í¼.

```
cd ~/environment/container-demo/cdk
pip install -r requirements.txt
cdk context --clear && cdk deploy --require-approval never
```

ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë°°í¬
ë‹¤ìŒìœ¼ë¡œ 3ê³„ì¸µ ë‹¤ì¤‘ ì–¸ì–´ ì›¹ ì•±ì„ ECS í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•©ë‹ˆë‹¤. ë°°í¬ ì¤‘ì¸ í•­ëª©ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ë‹¤ìŒì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì›Œí¬ìƒµ ì„¹ì…˜.

```
cd ~/environment/ecsdemo-frontend/cdk
pip install -r requirements.txt
cdk context --clear && cdk deploy --require-approval never
cd ~/environment/ecsdemo-nodejs/cdk
pip install -r requirements.txt
cdk context --clear && cdk deploy --require-approval never
cd ~/environment/ecsdemo-crystal/cdk
pip install -r requirements.txt
cdk context --clear && cdk deploy --require-approval never
```

### ì»¨í…Œì´ë„ˆ ì¸ì‚¬ì´íŠ¸ ì„¤ì •

ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
ì´ ì„¹ì…˜ì—ì„œëŠ” ë°©ê¸ˆ êµ¬ì¶•í•œ ECS í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ì»¨í…Œì´ë„ˆ í†µì°°ë ¥ì„ ì„¤ì •í•©ë‹ˆë‹¤.

í´ëŸ¬ìŠ¤í„° ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë©´ ê³„ì • ë° ë¦¬ì „ì— ìˆëŠ” ECS í´ëŸ¬ìŠ¤í„°ê°€ ë‚˜ì—´ë˜ê³  Container Insightsë¥¼ í™œì„±í™”í•˜ëŠ” ë° í•„ìš”í•œ í´ëŸ¬ìŠ¤í„° ì´ë¦„ì´ í‘œì‹œë©ë‹ˆë‹¤.

```
cluster_arn=$(aws ecs list-clusters | jq -r '.clusterArns[] | select(contains("container-demo"))')
clustername=$(aws ecs describe-clusters --clusters $cluster_arn | jq -r '.clusters[].clusterName')
```

ì»¨í…Œì´ë„ˆ ì¸ì‚¬ì´íŠ¸ í™œì„±í™”
ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ì—ì„œ Container Insightsë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤. ì´ ëª…ë ¹ì€ ECS í´ëŸ¬ìŠ¤í„°ì—ì„œ ì„œë¹„ìŠ¤ ë° í´ëŸ¬ìŠ¤í„° ìˆ˜ì¤€ í†µì°°ë ¥ì„ í™œì„±í™”í•©ë‹ˆë‹¤.

```
aws ecs update-cluster-settings --cluster ${clustername}  --settings name=containerInsights,value=enabled --region ${AWS_REGION}
```

ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ì¤€ í†µì°°ë ¥ í™œì„±í™”
ë‹¤ìŒ ëª…ë ¹ì€ ECS í´ëŸ¬ìŠ¤í„°ì— ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ì¤€ í†µì°°ë ¥ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```
aws cloudformation create-stack --stack-name CWAgentECS-$clustername-${AWS_REGION} --template-body "$(curl -Ls https://raw.githubusercontent.com/aws-samples/amazon-cloudwatch-container-insights/latest/ecs-task-definition-templates/deployment-mode/daemon-service/cwagent-ecs-instance-metric/cloudformation-quickstart/cwagent-ecs-instance-metric-cfn.json)" --parameters ParameterKey=ClusterName,ParameterValue=$clustername ParameterKey=CreateIAMRoles,ParameterValue=True --capabilities CAPABILITY_NAMED_IAM --region ${AWS_REGION}
```

ECS í´ëŸ¬ìŠ¤í„°ì—ì„œ Container Insights ìœ íš¨ì„± ê²€ì‚¬ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.
ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰

```
aws ecs describe-clusters --cluster ${clustername}
```

ì¶œë ¥ì€ ì•„ë˜ì˜ ê²ƒê³¼ ìœ ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤. JSONì˜ ì„¤ì • ì„¹ì…˜ì—ì„œ Container Insightsê°€ í™œì„±í™”ëœ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```
{
    "clusters": [
        {
            "status": "ACTIVE", 
            "statistics": [], 
            "tags": [], 
            "clusterName": "container-demo-ECSCluster-1E4H2VVHM9D2R", 
            "settings": [
                {
                    "name": "containerInsights", 
                    "value": "enabled"
                }
            ], 
            "registeredContainerInstancesCount": 0, 
            "pendingTasksCount": 0, 
            "runningTasksCount": 9, 
            "activeServicesCount": 3, 
            "clusterArn": "arn:aws:ecs:us-west-2:1234567899:cluster/container-demo-ECSCluster-1E4H2VVHM9D2R"
        }
    ], 
    "failures": []
}
```

### ì»¨í…Œì´ë„ˆ ì¸ì‚¬ì´íŠ¸ ì‚´í´ë³´ê¸°

ë¡œê·¸ê°€ CloudWatch Logsë¡œ ìŠ¤íŠ¸ë¦¬ë°ë˜ëŠ”ì§€ í™•ì¸
ë¡œ ì´ë™ CloudWatch ë¡œê·¸ ê·¸ë¦¬ê³  ì•„ë˜ í˜•ì‹ì˜ ë¡œê·¸ ê·¸ë£¹ì„ ë³¼ ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.

/aws/ecs/containerinsights/ í´ëŸ¬ìŠ¤í„° ì´ë¦„ /ì„±ëŠ¥

CloudWatch Container Insights ì‚´í´ë³´ê¸°
Amazon CloudWatch ë¡œ ì´ë™. ì•„ë˜ì™€ ê°™ì´ í™ˆ í˜ì´ì§€ì˜ ë“œë¡­ë‹¤ìš´ì—ì„œ Container Insightsë¥¼ ì„ íƒí•©ë‹ˆë‹¤.

![](./images/ContainerInsights1.png)

ì„ íƒ ECS í´ëŸ¬ìŠ¤í„°ë¥¼ ì²« ë²ˆì§¸ ë“œë¡­ ë‹¤ìš´ê³¼ ë‘ ë²ˆì§¸ ë“œë¡­ ë‹¤ìš´ì—ì„œ ë§Œë“  í´ëŸ¬ìŠ¤í„° ECSë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì´ ê¸°ë³¸ ëŒ€ì‹œë³´ë“œì—ì„œ CPU ì‚¬ìš©ë¥ , ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ , ë„¤íŠ¸ì›Œí¬ ë° ê¸°íƒ€ ì •ë³´ì™€ ê°™ì€ ë‹¤ì–‘í•œ í´ëŸ¬ìŠ¤í„° ìˆ˜ì¤€ ë©”íŠ¸ë¦­ì„ ë³´ì—¬ì£¼ëŠ” ì—¬ëŸ¬ ë‚´ì¥ ì°¨íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights2.png)

í´ëŸ¬ìŠ¤í„° ì´ë¦„ì„ ì„ íƒí•˜ê³  ì•„ë˜ì™€ ê°™ì´ ì‘ì—… ë“œë¡­ë‹¤ìš´ì„ í´ë¦­í•˜ì—¬ ì„±ëŠ¥ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights3.png)

ë˜í•œ ì•„ë˜ì™€ ê°™ì´ ì²« ë²ˆì§¸ ë“œë¡­ë‹¤ìš´ì—ì„œ ECS ì„œë¹„ìŠ¤ë¥¼ ì„ íƒí•˜ê¸°ë§Œ í•˜ë©´ í´ëŸ¬ìŠ¤í„°ë¥¼ ë“œë¦´ë‹¤ìš´í•˜ê³  ì„œë¹„ìŠ¤ ìˆ˜ì¤€ì—ì„œ ë©”íŠ¸ë¦­ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œëŠ” ì‘ì—… ì •ë³´, ë°°í¬ ì •ë³´ì™€ ê°™ì€ ECS ì„œë¹„ìŠ¤ì™€ ê´€ë ¨ëœ ì°¨íŠ¸ë¥¼ í‘œì‹œí•˜ë„ë¡ ì¡°ì •ë©ë‹ˆë‹¤.

![](./images/ContainerInsights4.png)

ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•˜ì—¬ ë‚˜ì—´ëœ ì„œë¹„ìŠ¤ì˜ ì¼ë¶€ì¸ ëª¨ë“  ì‘ì—…ì„ í™•ì¸í•©ë‹ˆë‹¤. ëª©ë¡ì—ì„œ ì‘ì—…ì„ ì„ íƒ í•˜ê³  ì‘ì—… ë“œë¡­ë‹¤ìš´ì„ í´ë¦­í•˜ì—¬ ì‘ì—…ë³„ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸, X-Ray ì¶”ì  ë° ì„±ëŠ¥ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights5.png)

ì„ íƒ ECS ì‘ì—…ì„ ì²« ë²ˆì§¸ ë“œë¡­ ë‹¤ìš´ê³¼ ë‘ ë²ˆì§¸ ë“œë¡­ ë‹¤ìš´ì—ì„œ ë§Œë“  í´ëŸ¬ìŠ¤í„° ECSë¥¼ ì„ íƒí•©ë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì´ ê¸°ë³¸ ëŒ€ì‹œë³´ë“œì—ì„œ CPU ì‚¬ìš©ë¥ , ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ , ë„¤íŠ¸ì›Œí¬, ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ìˆ˜, ë³´ë¥˜ ì¤‘ì¸ ì‘ì—… ìˆ˜ ë° ê¸°íƒ€ ì •ë³´ì™€ ê°™ì€ ë‹¤ì–‘í•œ ì‘ì—… ìˆ˜ì¤€ ë©”íŠ¸ë¦­ì„ ë³´ì—¬ì£¼ëŠ” ì—¬ëŸ¬ ë‚´ì¥ ì°¨íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights6.png)

ì„œë¹„ìŠ¤ì—ì„œ ì‘ì—…ì˜ ì¼ë¶€ì¸ ëª¨ë“  ì»¨í…Œì´ë„ˆë¥¼ ë³´ë ¤ë©´ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤. ëª©ë¡ì—ì„œ ì»¨í…Œì´ë„ˆë¥¼ ì„ íƒí•˜ê³  ì‘ì—… ë“œë¡­ë‹¤ìš´ì„ í´ë¦­í•˜ì—¬ ì»¨í…Œì´ë„ˆë³„ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸, X-Ray ì¶”ì  ë° ì„±ëŠ¥ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights7.png)

ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ì¤€ í†µì°°ë ¥ë„ ì„¤ì¹˜í–ˆê¸° ë•Œë¬¸ì— ì²« ë²ˆì§¸ ë“œë¡­ë‹¤ìš´ì—ì„œ ECS ì¸ìŠ¤í„´ìŠ¤ ë¥¼ ì„ íƒí•˜ì—¬ ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ì¤€ì—ì„œ í†µì°°ë ¥ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights12.png)

### ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì„¤ì •
ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì¤€ë¹„
ì´ì œ ECS í™˜ê²½ì— ëŒ€í•œ ëª¨ë‹ˆí„°ë§ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. Container Insightsë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”íŠ¸ë¦­ì´ ì–´ë–»ê²Œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•´ í™˜ê²½ì— ìˆ˜ë™ ë¡œë“œë¥¼ ìœ ë„í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ Siegeë¥¼ ì‚¬ìš©í•  ê²ƒì…ë‹ˆë‹¤.

```
# Install Siege for load testing
sudo yum -y install siege
```

í„°ë¯¸ë„ ì°½ì— ì•„ë˜ë¥¼ ì…ë ¥í•˜ì—¬ Siegeê°€ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì‹­ì‹œì˜¤.

```
siege --version
```

![](./images/ContainerInsights14.png)

### ë¶€í•˜ í…ŒìŠ¤íŠ¸ ìˆ˜í–‰
Siegeë¥¼ ì‹¤í–‰í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œë“œ í…ŒìŠ¤íŠ¸
ë¡œë“œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ê¸° ìœ„í•´ ë¡œë“œ ë°¸ëŸ°ì„œ URLì„ ì¡ì•„ë´…ì‹œë‹¤.

```
alb_url=$(aws cloudformation describe-stacks --stack-name container-demo-alb --query 'Stacks[0].Outputs[?OutputKey==`ExternalUrl`].OutputValue' --output text 2> /dev/null || aws cloudformation describe-stacks --stack-name ecsworkshop-frontend | jq -r '.Stacks[].Outputs[] | select(.OutputKey | contains("FrontendFargateLBServiceServiceURL")) | .OutputValue')
```

ì°¸ê³  : ì˜¤ë¥˜ê°€ í‘œì‹œë˜ëŠ” ê²½ìš°

Siege ë””ë ‰í„°ë¦¬ì˜ í„°ë¯¸ë„ ì°½ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

```
siege -c 200 -i $alb_url
```

ì´ ëª…ë ¹ì€ ë‹¤ì–‘í•œ URLì—ì„œ ECS ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ 200ê°œì˜ ë™ì‹œ ì—°ê²°ì„ ì‹¤í–‰í•˜ë„ë¡ Siegeì— ì§€ì‹œí•©ë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì€ ì¶œë ¥ì´ í‘œì‹œë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì²˜ìŒì—ëŠ” ì‚¬ì´íŠ¸ ë£¨íŠ¸ì— ëŒ€í•œ ì—°ê²°ì´ í‘œì‹œë˜ê³  ì‚¬ì´íŠ¸ì˜ ë‹¤ì–‘í•œ URLë¡œ ì´ë™í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

ì´ í…ŒìŠ¤íŠ¸ë¥¼ 15-20ì´ˆ ë™ì•ˆ ì‹¤í–‰í•œ ë‹¤ìŒ í„°ë¯¸ë„ ì°½ì—ì„œ ctrl+cë¡œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë” ì˜¤ë˜ ì‹¤í–‰í•  ìˆ˜ ìˆì§€ë§Œ ì•½ 30ì´ˆ ì´ë‚´ì— í´ëŸ¬ìŠ¤í„°ì˜ ì—´ë¦° ì—°ê²°ì´ ìµœëŒ€í™”ë˜ê³  ìì²´ì ìœ¼ë¡œ ì¢…ë£Œë©ë‹ˆë‹¤.

![](./images/ContainerInsights15.png)

### ë¶€í•˜ í…ŒìŠ¤íŠ¸ ì¸¡ì •í•­ëª©
Container Insights í™ˆ í˜ì´ì§€ë¡œ ì´ë™í•˜ì—¬ ì•„ë˜ì™€ ê°™ì´ ì‹œê°„ ë²”ìœ„ë¥¼ 15ë¶„ ìœ¼ë¡œ ì„ íƒí•©ë‹ˆë‹¤.

![](./images/ContainerInsights17.png)

ì•„ë˜ ìŠ¤í¬ë¦°ìƒ·ì—ì„œ ë©”íŠ¸ë¦­ì´ ê·¸ë˜í”„ ìœ„ì ¯ì— í‘œì‹œë˜ê¸° ì‹œì‘í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. íŠ¹íˆ, Siegeê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œë“œë¥¼ ì¦ê°€ì‹œí‚¤ë©´ CPU ì‚¬ìš©ë¥ ì´ ì¦ê°€í•˜ëŠ” ê²ƒì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.

![](./images/ContainerInsights13.png)

![](./images/ContainerInsights16.png)

### CLOUDWATCH ì§€í‘œì— ëŒ€í•œ ê²½ë³´ ì„¤ì •
CloudWatch ê²½ë³´
Container Insightsë¥¼ í†µí•´ ìº¡ì²˜ëœ ë©”íŠ¸ë¦­ì€ í™˜ê²½ ë™ì‘ì˜ ì´ìƒì— ëŒ€í•œ ì•Œë¦¼ì„ ë°›ë„ë¡ ê²½ë³´ë¥¼ ì„¤ì •í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

CloudWatch Container Insightsì—ì„œëŠ” ë“œë¦´ë‹¤ìš´í•˜ì—¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ CPU ì‚¬ìš©ë¥ ì„ ìœ„í•œ CloudWatchë¥¼ ì‚¬ìš©í•˜ì—¬ ê²½ë³´ë¥¼ ìƒì„±í•˜ê² ìŠµë‹ˆë‹¤. ECS Servicesë¥¼ ì„ íƒ í•˜ê³  CPU Utilization ìƒìì˜ ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ìˆëŠ” ì„¸ ê°œì˜ ìˆ˜ì§ ì ì„ í´ë¦­í•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  ë©”íŠ¸ë¦­ ì—ì„œ ë³´ê¸°ë¥¼ ì„ íƒ í•©ë‹ˆë‹¤.

![](./images/ContainerInsights18.png)

ê·¸ëŸ¬ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤. ecsdemo-frontend ì„œë¹„ìŠ¤ì˜ CPU ì‚¬ìš©ë¥  ìŠ¤íŒŒì´í¬ê°€ ê½¤ ìˆìŒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤ . ecsdemo-frontend ë¼ì¸ í•­ëª©ì— í•´ë‹¹í•˜ëŠ” ğŸ”” ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ì´ ë©”íŠ¸ë¦­ì— ëŒ€í•œ ê²½ë³´ë¥¼ ì„¤ì •í•´ ë³´ê² ìŠµë‹ˆë‹¤ .

![](./images/ContainerInsights19.png)

ë©”íŠ¸ë¦­ ì¡°ê±´ ì§€ì • í™”ë©´, ê¸°ë³¸ê°’ìœ¼ë¡œ íœ´ê°€ ëª¨ë‘ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤ (50) ì—ì„œ ì„ê³„ ê°’ì„ ì •ì˜ í™”ë©´. ì´ë ‡ê²Œ í•˜ë©´ ê²½ë³´ì— ëŒ€í•œ CPU ì‚¬ìš©ë¥  ì„ê³„ê°’ì„ 50%ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ë‹¤ìŒ ì„ íƒ

![](./images/ContainerInsights20.png)

êµ¬ì„± ì‘ì—… í™”ë©´, ì„ íƒ ìƒˆ í•­ëª© ë§Œë“¤ê¸° ì˜µì…˜ ë° ê²½ë³´ ì•Œë¦¼ì„ ë³´ë‚¼ í•  ìˆ˜ìˆëŠ” ì´ë©”ì¼ IDë¥¼ ì…ë ¥í•©ë‹ˆë‹¤. ë‹¤ìŒ ì„ íƒ

![](./images/ContainerInsights21.png)

ì„¤ëª…ì˜ ì¶”ê°€ í™”ë©´, ì•ŒëŒì˜ ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì„ íƒ ë‹¤ìŒì„

![](./images/ContainerInsights22.png)

ê²€í†  í™”ë©´ì—ì„œ ì•ŒëŒ ìƒì„±ì„ ì„ íƒí•˜ì—¬ ì•ŒëŒ ì„ ìƒì„±í•©ë‹ˆë‹¤. ì™„ë£Œë˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

![](./images/ContainerInsights23.png)

ì´ì œ ì…ë ¥í•œ ì´ë©”ì¼ ë°›ì€ í¸ì§€í•¨ìœ¼ë¡œ ì´ë™í•˜ì—¬ í™•ì¸ ì´ë©”ì¼ì„ ì°¾ì•„ CloudWatchì—ì„œ ê²½ë³´ ì•Œë¦¼ì„ ìˆ˜ì‹ í•  ê²ƒì„ì„ í™•ì¸í•©ë‹ˆë‹¤.

![](./images/ContainerInsights24.png)

êµ¬ë… í™•ì¸ ì„ í´ë¦­í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™•ì¸ í™”ë©´ì´ í‘œì‹œë©ë‹ˆë‹¤.

![](./images/ContainerInsights25.png)

### CLOUDWATCH ê²½ë³´ íŠ¸ë¦¬ê±°

CloudWatch ê²½ë³´ë¥¼ íŠ¸ë¦¬ê±°í•  ë¶€í•˜ ìƒì„±
ìš°ë¦¬ëŠ” ë‹¤ì‹œ í•œë²ˆ Siegeë¥¼ ì‚¬ìš©í•˜ì—¬ í™˜ê²½ì— ë¶€í•˜ë¥¼ ìƒì„±í•˜ì—¬ ê²½ë³´ê°€ íŠ¸ë¦¬ê±°ë  ìˆ˜ ìˆë„ë¡ í•  ê²ƒì…ë‹ˆë‹¤.

Cloud9 Workspaceì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ê³  CPU ì‚¬ìš©ë¥ ì´ ì˜¬ë¼ê°€ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```
alb_url=$(aws cloudformation describe-stacks --stack-name container-demo-alb --query 'Stacks[0].Outputs[?OutputKey==`ExternalUrl`].OutputValue' --output text 2> /dev/null || aws cloudformation describe-stacks --stack-name ecsworkshop-frontend | jq -r '.Stacks[].Outputs[] | select(.OutputKey | contains("FrontendFargateLBServiceServiceURL")) | .OutputValue')

siege -c 200 -i $alb_url
```

ì•½ 5ë¶„ ì •ë„ í›„ì— ì•„ë˜ì™€ ê°™ì´ CPU ì‚¬ìš©ë¥ ì´ 50% í‘œì‹œë¥¼ ë„˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](./images/ContainerInsights26.png)

ê·¸ëŸ¬ë©´ ì´ì „ì— êµ¬ì„±í•œ ì•ŒëŒì´ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤. ì•ŒëŒì˜ ìƒíƒœëŠ” ì•„ë˜ì™€ ê°™ì´ In ì•ŒëŒ ì…ë‹ˆë‹¤.

![](./images/ContainerInsights27.png)

ë˜í•œ ì•„ë˜ì™€ ê°™ì€ ì´ë©”ì¼ ì•Œë¦¼ì„ ë°›ê²Œ ë©ë‹ˆë‹¤.

![](./images/ContainerInsights28.png)

### CLOUDWATCH LOGS INSIGHTS
ë¡œê·¸ ì¸ì‚¬ì´íŠ¸ë€ ë¬´ì—‡ì…ë‹ˆê¹Œ?
CloudWatch Logs InsightsCloudWatchë¥¼ ìœ„í•œ ì™„ì „íˆ í†µí•©ëœ ëŒ€í™”í˜• ì¢…ëŸ‰ì œ ë¡œê·¸ ë¶„ì„ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤. CloudWatch Logs Insightsë¥¼ ì‚¬ìš©í•˜ë©´ ì¦‰ì‹œ ë¡œê·¸ë¥¼ íƒìƒ‰, ë¶„ì„ ë° ì‹œê°í™”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìš´ì˜ ë¬¸ì œë¥¼ ì‰½ê²Œ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ECSì—ì„œ ë¡œê·¸ ì¿¼ë¦¬
ë¡œ ì´ë™ CloudWatch Logs Insightsì„ íƒ / AWS / ECS / containerinsights / í´ëŸ¬ìŠ¤í„° ì´ë¦„ / ì„±ëŠ¥ ë¡œê·¸ ê·¸ë£¹ì€ ë‹¤ìŒê³¼ ê°™ì´

![](./images/ContainerInsights8.png)

ë‹¤ìŒ ì¿¼ë¦¬ë¥¼ ë³µì‚¬í•˜ì—¬ í…ìŠ¤íŠ¸ ìƒìì— ë¶™ì—¬ë„£ê³  ì¿¼ë¦¬ ì‹¤í–‰ì„ í´ë¦­í•©ë‹ˆë‹¤.

```
stats count_distinct(TaskId) as Number_of_Tasks by ServiceName
```

ì´ ì¿¼ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ì´ ì„œë¹„ìŠ¤ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ ì‘ì—… ìˆ˜ë¥¼ ë³´ì—¬ì£¼ëŠ” í…Œì´ë¸”ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

![](./images/ContainerInsights9.png)

ë‹¤ìŒ ì¿¼ë¦¬ëŠ” filter ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ 5ë¶„ë§ˆë‹¤ ì‘ì—…ì—ì„œ ì‚¬ìš©í•œ í‰ê·  ë©”ëª¨ë¦¬ ë° CPUë¥¼ ë³´ì—¬ì£¼ëŠ” í…Œì´ë¸”ì„ ë°˜í™˜í•©ë‹ˆë‹¤.

```
stats avg(MemoryUtilized) as Avg_Memory, avg(CpuUtilized) as Avg_CPU by bin(5m)
| filter Type="Task"
```

![](./images/ContainerInsights10.png)

ì‹œê°í™” íƒ­ì„ í´ë¦­í•˜ê¸°ë§Œ í•˜ë©´ ê·¸ë˜í”„ì—ì„œ ì¶œë ¥ì„ ì‹œê°í™”í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤ . ë‹¤ìŒ ìŠ¤í¬ë¦°ìƒ·ì€ ë™ì¼í•œ ë³´ê³ ì„œì˜ ë§‰ëŒ€ ì°¨íŠ¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.

![](./images/ContainerInsights11.png)

### ë¦¬ì†ŒìŠ¤ ì •ë¦¬
ë³´ì‹œë‹¤ì‹œí”¼ CloudWatch Container Insightsë¥¼ ì‘ë™ì‹œí‚¤ê³  CPU ë° ê¸°íƒ€ ì§€í‘œì— ëŒ€í•œ ê²½ë³´ë¥¼ ì„¤ì •í•˜ëŠ” ê²ƒì€ ë§¤ìš° ì‰½ìŠµë‹ˆë‹¤. CloudWatch Container Insightsë¥¼ ì‚¬ìš©í•˜ë©´ ìì²´ ëª¨ë‹ˆí„°ë§ ì¸í”„ë¼ë¥¼ ê´€ë¦¬ ë° ì—…ë°ì´íŠ¸í•  í•„ìš”ê°€ ì—†ìœ¼ë©° í”Œë«í¼ì„ ê´€ë¦¬í•  í•„ìš”ê°€ ì—†ëŠ” ê¸°ë³¸ AWS ì†”ë£¨ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì»¨í…Œì´ë„ˆ ì¸ì‚¬ì´íŠ¸ ë¹„í™œì„±í™”
ECS í´ëŸ¬ìŠ¤í„°ì— ëŒ€í•œ ì»¨í…Œì´ë„ˆ í†µì°°ë ¥ì„ ë¹„í™œì„±í™”í•˜ë ¤ë©´ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

```
aws ecs update-cluster-settings --cluster ${clustername} --settings name=containerInsights,value=disabled --region ${AWS_REGION}
```

ì¶œë ¥ì€ ì•„ë˜ì™€ ìœ ì‚¬í•´ì•¼ í•©ë‹ˆë‹¤.

```
{
    "cluster": {
        "status": "ACTIVE", 
        "statistics": [], 
        "tags": [], 
        "clusterName": "container-demo-ECSCluster-1E4H2VVHM9D2R", 
        "settings": [
            {
                "name": "containerInsights", 
                "value": "disabled"
            }
        ], 
        "registeredContainerInstancesCount": 0, 
        "pendingTasksCount": 0, 
        "runningTasksCount": 0, 
        "activeServicesCount": 0, 
        "clusterArn": "arn:aws:ecs:us-west-2:123456789:cluster/container-demo-ECSCluster-1E4H2VVHM9D2R"
    }
}
```

[CloudFormation]ìœ¼ë¡œ ì´ë™(https://console.aws.amazon.com/cloudformation/home) ì¸ìŠ¤í„´ìŠ¤ ìˆ˜ì¤€ í†µì°°ë ¥ì„ í™œì„±í™”í•˜ê¸° ìœ„í•´ ìƒì„±ëœ ìŠ¤íƒì„ ì‚­ì œí•©ë‹ˆë‹¤.

![](./images/ContainerInsights29.png)

í”„ëŸ°íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ìŠ¤íƒê³¼ í”Œë«í¼ ìŠ¤íƒì„ ì‚­ì œí•©ë‹ˆë‹¤.

```
cd ~/environment/ecsdemo-frontend/cdk
cdk destroy -f
cd ~/environment/ecsdemo-nodejs/cdk
cdk destroy -f
cd ~/environment/ecsdemo-crystal/cdk
cdk destroy -f
cd ~/environment/container-demo/cdk
cdk destroy -f

python -c "import boto3
c = boto3.client('logs')
services = ['ecsworkshop-frontend', 'ecsworkshop-nodejs', 'ecsworkshop-crystal']
for service in services:
    frontend_logs = c.describe_log_groups(logGroupNamePrefix=service)
    print([c.delete_log_group(logGroupName=x['logGroupName']) for x in frontend_logs['logGroups']])"
```
